name: Deploy to GKE

on:
  push:
    branches: 
      - main

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest

    steps:

    - name: Checkout
      uses: actions/checkout@v2

    # - name: Decode Google Cloud credentials
    #   run: echo ""{\"type\":\"service_account\",\"project_id\":\"unique-magpie-388510\",\"private_key_id\":\"0a34af50970cc11b218bdc493f6bb0f7187ae15a\",\"private_key\":\"-----BEGIN PRIVATE KEY-----\\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC5tBwChF7ZNxVZ\\nv08DoJ9VPwo5RKH10OyLID79xQTJ8TIcmxsv7+3YBcscxtzGVOWALxzGyq2d6Q27\\n34sALmdR9TxLAPLL5nIsF9+Z2mpGxTdq3SZpTF5WRLiamGRC3vUmGyJJsH+HH5+E\\naNgW3JW3y5MJAs4RO77a4jT8yxVd3iXk1HzJnAEI6LvW1TfmRO+q8C2acAwy+OZH\\nrUU\\/V9LnKwGdF+I6ov4PBdddjhZoFnKTm+GhHypAnPn7daVgpe+NxNg+g5EVRcKm\\n9c6vT5jxF66fUz3FMoZJXj7IkuVltMefXDGmqoc76w1k8HNqneta7hcczJSj+pTe\\nVfZR98aBAgMBAAECggEADOvLRyGOt+5tPeFhzg7PB09rlrB\\/1GrFCqkjuOSMgMCX\\njAX+zkcTdYRxrX7ovaQKk\\/CzP+G6UtJ0ci4LreeMqNc3asCWJDnUl9zRYhMgcewm\\n\\/viEQ69coQQHFDqmP0DkLdKVgCsXtH8uyjfBUVXn1PIFOQtI60oM7Y3vwecfhXhh\\nMuehJ7eyhrMBdOoFTGU0AQ2orpIH9GAlqp4pPAapL5KesR0QZmeEg8IyaIcBk2x\\/\\ny7LnNEXC1Y08n90pmHfkb2YvJ8ZNXPeEo40DzRgpwLIB0TTT5FDxtkb2SWNA9gvC\\nBiRGkLSp1PFI9rPTd3+kPxo\\/S15raX\\/7pG8Jdk2wQQKBgQDbUhyk2R0jLqnT5yrO\\nTa849Qmd5Ifam0TdDDsFGc08VaPTZQMP2Z9lcGtIiXC5JTnoOZfdjTVwJKQsLXhe\\njTIdPStngDd1LMBTb4UO2Slkjn3SdFw4D5nLLP9\\/8BL4fjYpwvpmQgapPSGd4rBC\\nKp9Z2sfNdJ03HTMja\\/MCN9vcMwKBgQDYwrpPcViQsYOc7+tpPF\\/L6s3DH0xuUEl6\\ntH6cGBLUMoyq3ZjHZ8FpRxjdRanSWIcGv12tcYA7uEM8c52IFPDZ\\/V1Wzw69aLJB\\nrtBy6wkTjQ59q\\/ByyDAyLA0ysyLTOzczwuChy07XKxM1kplyL6bHd0BtRYGfjVNH\\n4SthY10eewKBgQCeyfd1HsBqzYklo5OpZDM94KNCzsfRbWNRS16b1c9zJGoFTngG\\nDMDL97WlAeU8Fwiy6qfaPzd2ZwD5\\/z3L7xxecQAw4nLEgk8I2ZATbQT8CfJs4dQ2\\nvozRvlWJ8m45vV9HoyQZzyn1dA4Xup10ell++9h3FzwQQDLbLXf2niyvYwKBgGCK\\nkjpxzDVdqrXKMbpENpJ2+L\\/v\\/7WeMqvhGgbhvfkeroIngjVF4+HE1bEvpsxVu4Xo\\n04s9YxS2I9QX1lDWqtMcQmc4f2Mi70nL13Fndzpq98pHOyeUO8sMzbAIEvmrhRGb\\nuTq2d13kBIE20vsFeC2c0mgYrfvnEPGRuyV8AOxjAoGAOPrUiAFd85b+oOOdgHCx\\nOT5NV05MEIql4STWMM0V1ZqWFisL2oCpD0Ehfc4hsasZ00m5qQrD4oBBSaQ5\\/50n\\nCbw33Gla2ybCPq5eAcml1cjrcZDrudPDw0fkPS6ujomKi4WY9Ug5pVKimfyX\\/QTJ\\ne67JQyQofvfCt1kTT7jV\\/VM=\\n-----END PRIVATE KEY-----\\n\",\"client_email\":\"githubactionsproject@unique-magpie-388510.iam.gserviceaccount.com\",\"client_id\":\"110332038333719717193\",\"auth_uri\":\"https:\\/\\/accounts.google.com\\/o\\/oauth2\\/auth\",\"token_uri\":\"https:\\/\\/oauth2.googleapis.com\\/token\",\"auth_provider_x509_cert_url\":\"https:\\/\\/www.googleapis.com\\/oauth2\\/v1\\/certs\",\"client_x509_cert_url\":\"https:\\/\\/www.googleapis.com\\/robot\\/v1\\/metadata\\/x509\\/githubactionsproject%40unique-magpie-388510.iam.gserviceaccount.com\",\"universe_domain\":\"googleapis.com\"}"" | base64 -d > ./gcp-sa-key.json

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v0.2.1
      with:
        service_account_key: "{\"type\":\"service_account\",\"project_id\":\"unique-magpie-388510\",\"private_key_id\":\"0a34af50970cc11b218bdc493f6bb0f7187ae15a\",\"private_key\":\"-----BEGIN PRIVATE KEY-----\\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC5tBwChF7ZNxVZ\\nv08DoJ9VPwo5RKH10OyLID79xQTJ8TIcmxsv7+3YBcscxtzGVOWALxzGyq2d6Q27\\n34sALmdR9TxLAPLL5nIsF9+Z2mpGxTdq3SZpTF5WRLiamGRC3vUmGyJJsH+HH5+E\\naNgW3JW3y5MJAs4RO77a4jT8yxVd3iXk1HzJnAEI6LvW1TfmRO+q8C2acAwy+OZH\\nrUU\\/V9LnKwGdF+I6ov4PBdddjhZoFnKTm+GhHypAnPn7daVgpe+NxNg+g5EVRcKm\\n9c6vT5jxF66fUz3FMoZJXj7IkuVltMefXDGmqoc76w1k8HNqneta7hcczJSj+pTe\\nVfZR98aBAgMBAAECggEADOvLRyGOt+5tPeFhzg7PB09rlrB\\/1GrFCqkjuOSMgMCX\\njAX+zkcTdYRxrX7ovaQKk\\/CzP+G6UtJ0ci4LreeMqNc3asCWJDnUl9zRYhMgcewm\\n\\/viEQ69coQQHFDqmP0DkLdKVgCsXtH8uyjfBUVXn1PIFOQtI60oM7Y3vwecfhXhh\\nMuehJ7eyhrMBdOoFTGU0AQ2orpIH9GAlqp4pPAapL5KesR0QZmeEg8IyaIcBk2x\\/\\ny7LnNEXC1Y08n90pmHfkb2YvJ8ZNXPeEo40DzRgpwLIB0TTT5FDxtkb2SWNA9gvC\\nBiRGkLSp1PFI9rPTd3+kPxo\\/S15raX\\/7pG8Jdk2wQQKBgQDbUhyk2R0jLqnT5yrO\\nTa849Qmd5Ifam0TdDDsFGc08VaPTZQMP2Z9lcGtIiXC5JTnoOZfdjTVwJKQsLXhe\\njTIdPStngDd1LMBTb4UO2Slkjn3SdFw4D5nLLP9\\/8BL4fjYpwvpmQgapPSGd4rBC\\nKp9Z2sfNdJ03HTMja\\/MCN9vcMwKBgQDYwrpPcViQsYOc7+tpPF\\/L6s3DH0xuUEl6\\ntH6cGBLUMoyq3ZjHZ8FpRxjdRanSWIcGv12tcYA7uEM8c52IFPDZ\\/V1Wzw69aLJB\\nrtBy6wkTjQ59q\\/ByyDAyLA0ysyLTOzczwuChy07XKxM1kplyL6bHd0BtRYGfjVNH\\n4SthY10eewKBgQCeyfd1HsBqzYklo5OpZDM94KNCzsfRbWNRS16b1c9zJGoFTngG\\nDMDL97WlAeU8Fwiy6qfaPzd2ZwD5\\/z3L7xxecQAw4nLEgk8I2ZATbQT8CfJs4dQ2\\nvozRvlWJ8m45vV9HoyQZzyn1dA4Xup10ell++9h3FzwQQDLbLXf2niyvYwKBgGCK\\nkjpxzDVdqrXKMbpENpJ2+L\\/v\\/7WeMqvhGgbhvfkeroIngjVF4+HE1bEvpsxVu4Xo\\n04s9YxS2I9QX1lDWqtMcQmc4f2Mi70nL13Fndzpq98pHOyeUO8sMzbAIEvmrhRGb\\nuTq2d13kBIE20vsFeC2c0mgYrfvnEPGRuyV8AOxjAoGAOPrUiAFd85b+oOOdgHCx\\nOT5NV05MEIql4STWMM0V1ZqWFisL2oCpD0Ehfc4hsasZ00m5qQrD4oBBSaQ5\\/50n\\nCbw33Gla2ybCPq5eAcml1cjrcZDrudPDw0fkPS6ujomKi4WY9Ug5pVKimfyX\\/QTJ\\ne67JQyQofvfCt1kTT7jV\\/VM=\\n-----END PRIVATE KEY-----\\n\",\"client_email\":\"githubactionsproject@unique-magpie-388510.iam.gserviceaccount.com\",\"client_id\":\"110332038333719717193\",\"auth_uri\":\"https:\\/\\/accounts.google.com\\/o\\/oauth2\\/auth\",\"token_uri\":\"https:\\/\\/oauth2.googleapis.com\\/token\",\"auth_provider_x509_cert_url\":\"https:\\/\\/www.googleapis.com\\/oauth2\\/v1\\/certs\",\"client_x509_cert_url\":\"https:\\/\\/www.googleapis.com\\/robot\\/v1\\/metadata\\/x509\\/githubactionsproject%40unique-magpie-388510.iam.gserviceaccount.com\",\"universe_domain\":\"googleapis.com\"}"
        project_id: "unique-magpie-388510"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Login to Google Container Registry
      uses: docker/login-action@v1 
      with:
        registry: gcr.io
        username: _json_key
        password: "{\"type\":\"service_account\",\"project_id\":\"unique-magpie-388510\",\"private_key_id\":\"0a34af50970cc11b218bdc493f6bb0f7187ae15a\",\"private_key\":\"-----BEGIN PRIVATE KEY-----\\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC5tBwChF7ZNxVZ\\nv08DoJ9VPwo5RKH10OyLID79xQTJ8TIcmxsv7+3YBcscxtzGVOWALxzGyq2d6Q27\\n34sALmdR9TxLAPLL5nIsF9+Z2mpGxTdq3SZpTF5WRLiamGRC3vUmGyJJsH+HH5+E\\naNgW3JW3y5MJAs4RO77a4jT8yxVd3iXk1HzJnAEI6LvW1TfmRO+q8C2acAwy+OZH\\nrUU\\/V9LnKwGdF+I6ov4PBdddjhZoFnKTm+GhHypAnPn7daVgpe+NxNg+g5EVRcKm\\n9c6vT5jxF66fUz3FMoZJXj7IkuVltMefXDGmqoc76w1k8HNqneta7hcczJSj+pTe\\nVfZR98aBAgMBAAECggEADOvLRyGOt+5tPeFhzg7PB09rlrB\\/1GrFCqkjuOSMgMCX\\njAX+zkcTdYRxrX7ovaQKk\\/CzP+G6UtJ0ci4LreeMqNc3asCWJDnUl9zRYhMgcewm\\n\\/viEQ69coQQHFDqmP0DkLdKVgCsXtH8uyjfBUVXn1PIFOQtI60oM7Y3vwecfhXhh\\nMuehJ7eyhrMBdOoFTGU0AQ2orpIH9GAlqp4pPAapL5KesR0QZmeEg8IyaIcBk2x\\/\\ny7LnNEXC1Y08n90pmHfkb2YvJ8ZNXPeEo40DzRgpwLIB0TTT5FDxtkb2SWNA9gvC\\nBiRGkLSp1PFI9rPTd3+kPxo\\/S15raX\\/7pG8Jdk2wQQKBgQDbUhyk2R0jLqnT5yrO\\nTa849Qmd5Ifam0TdDDsFGc08VaPTZQMP2Z9lcGtIiXC5JTnoOZfdjTVwJKQsLXhe\\njTIdPStngDd1LMBTb4UO2Slkjn3SdFw4D5nLLP9\\/8BL4fjYpwvpmQgapPSGd4rBC\\nKp9Z2sfNdJ03HTMja\\/MCN9vcMwKBgQDYwrpPcViQsYOc7+tpPF\\/L6s3DH0xuUEl6\\ntH6cGBLUMoyq3ZjHZ8FpRxjdRanSWIcGv12tcYA7uEM8c52IFPDZ\\/V1Wzw69aLJB\\nrtBy6wkTjQ59q\\/ByyDAyLA0ysyLTOzczwuChy07XKxM1kplyL6bHd0BtRYGfjVNH\\n4SthY10eewKBgQCeyfd1HsBqzYklo5OpZDM94KNCzsfRbWNRS16b1c9zJGoFTngG\\nDMDL97WlAeU8Fwiy6qfaPzd2ZwD5\\/z3L7xxecQAw4nLEgk8I2ZATbQT8CfJs4dQ2\\nvozRvlWJ8m45vV9HoyQZzyn1dA4Xup10ell++9h3FzwQQDLbLXf2niyvYwKBgGCK\\nkjpxzDVdqrXKMbpENpJ2+L\\/v\\/7WeMqvhGgbhvfkeroIngjVF4+HE1bEvpsxVu4Xo\\n04s9YxS2I9QX1lDWqtMcQmc4f2Mi70nL13Fndzpq98pHOyeUO8sMzbAIEvmrhRGb\\nuTq2d13kBIE20vsFeC2c0mgYrfvnEPGRuyV8AOxjAoGAOPrUiAFd85b+oOOdgHCx\\nOT5NV05MEIql4STWMM0V1ZqWFisL2oCpD0Ehfc4hsasZ00m5qQrD4oBBSaQ5\\/50n\\nCbw33Gla2ybCPq5eAcml1cjrcZDrudPDw0fkPS6ujomKi4WY9Ug5pVKimfyX\\/QTJ\\ne67JQyQofvfCt1kTT7jV\\/VM=\\n-----END PRIVATE KEY-----\\n\",\"client_email\":\"githubactionsproject@unique-magpie-388510.iam.gserviceaccount.com\",\"client_id\":\"110332038333719717193\",\"auth_uri\":\"https:\\/\\/accounts.google.com\\/o\\/oauth2\\/auth\",\"token_uri\":\"https:\\/\\/oauth2.googleapis.com\\/token\",\"auth_provider_x509_cert_url\":\"https:\\/\\/www.googleapis.com\\/oauth2\\/v1\\/certs\",\"client_x509_cert_url\":\"https:\\/\\/www.googleapis.com\\/robot\\/v1\\/metadata\\/x509\\/githubactionsproject%40unique-magpie-388510.iam.gserviceaccount.com\",\"universe_domain\":\"googleapis.com\"}"

    - name: Build and push Docker image
      uses: docker/build-push-action@v2
      with:
        context: ./app
        push: true
        tags: gcr.io/"unique-magpie-388510"/hello-world:latest

    - name: Configure Docker to use the gcloud command-line tool as a credential helper
      run: gcloud auth configure-docker

    - name: Install Helm
      uses: azure/setup-helm@v1

    - name: Deploy to GKE
      run: |
        gcloud container clusters get-credentials my-gke-cluster --zone us-central1-c
        helm upgrade --install hello-world ./chart --wait
